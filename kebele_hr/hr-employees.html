<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthFirst | Employees</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style/style.css">
</head>
<body>
    <div class="hr-container">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <i class="fas fa-heartbeat"></i>
                    <span class="logo-text">HealthFirst HR</span>
                </a>
                <button class="toggle-sidebar" id="toggleSidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <nav class="sidebar-menu">
                <ul>
                    <li class="menu-item">
                        <a href="kebele_hr_dashboard.php">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="menu-text">HR Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item active">
                        <a href="hr-employees.html">
                            <i class="fas fa-users"></i>
                            <span class="menu-text">Employees</span>
                            <span class="menu-badge">142</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-attendance.html">
                            <i class="fas fa-calendar-check"></i>
                            <span class="menu-text">Attendance</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-leave.html">
                            <i class="fas fa-umbrella-beach"></i>
                            <span class="menu-text">Leave Management</span>
                            <span class="menu-badge">8</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-recruitment.html">
                            <i class="fas fa-user-plus"></i>
                            <span class="menu-text">Recruitment</span>
                            <span class="menu-badge">5</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-training.html">
                            <i class="fas fa-graduation-cap"></i>
                            <span class="menu-text">Training</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-payroll.html">
                            <i class="fas fa-money-check-alt"></i>
                            <span class="menu-text">Payroll</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-reports.html">
                            <i class="fas fa-chart-bar"></i>
                            <span class="menu-text">HR Reports</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="hr-settings.html">
                            <i class="fas fa-cog"></i>
                            <span class="menu-text">HR Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Employee Management</h1>
                </div>

                <div class="header-actions">
                    <a href="add_employee.php" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Employee
                    </a>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Employees Table -->
                <div class="hr-section">
                    <div class="hr-section-header">
                        <h2 class="hr-section-title">All Employees</h2>
                        <div class="hr-section-actions">
                            <button class="section-action-btn">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button class="section-action-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="hr-section-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>ID</th>
                                        <th>Department</th>
                                        <th>Position</th>
                                        <th>Join Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody">
                                    <!-- Employees will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Employee Detail Modal -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Employee Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="employeeDetails">
                <!-- Employee details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Load employees on page load
        window.addEventListener('load', function() {
            fetch('get_kebele_hr_employees.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('employeesTableBody');
                    tbody.innerHTML = '';

                    // Handle new response format
                    const employees = data.employees || data; // Support both formats
                    const currentUser = data.current_user || 'Unknown';
                    
                    console.log('Current user:', currentUser);
                    console.log('Employees found:', employees.length);

                    if (employees.length > 0) {
                        employees.forEach(employee => {
                            const initials = employee.first_name.charAt(0) + employee.last_name.charAt(0);
                            const joinDate = employee.join_date ? new Date(employee.join_date).toLocaleDateString('en-GB') : 'N/A';
                            const statusClass = employee.status === 'active' ? 'active' : (employee.status === 'on-leave' ? 'on-leave' : 'inactive');
                            const statusText = employee.status === 'active' ? 'Active' : (employee.status === 'on-leave' ? 'On Leave' : 'Inactive');

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <div class="employee-info">
                                        <div class="employee-avatar">${initials}</div>
                                        <div>
                                            <div class="employee-name">${employee.first_name} ${employee.last_name}</div>
                                            <div class="employee-id">${employee.email || 'No email'}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${employee.employee_id}</td>
                                <td><span class="department-badge medical">${employee.department_assigned || 'Not Assigned'}</span></td>
                                <td>${employee.position || employee.job_level || 'Not Specified'}</td>
                                <td>${joinDate}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>
                                     <div class="action-buttons">
                                         <button class="action-btn view" onclick="viewEmployee('${employee.employee_id}')" title="View Details"><i class="fas fa-eye"></i></button>
                                         <button class="action-btn edit" onclick="editEmployee('${employee.employee_id}')" title="Edit Employee"><i class="fas fa-edit"></i></button>
                                         <button class="action-btn delete" onclick="deleteEmployee('${employee.employee_id}')" title="Delete Employee"><i class="fas fa-trash"></i></button>
                                     </div>
                                 </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i><br>
                                    <strong>No employees found</strong><br>
                                    <small>You haven't created any employees yet. <a href="add_employee.php">Add your first employee</a></small>
                                </td>
                            </tr>
                        `;
                    }

                    // Update badge with actual count
                    const badge = document.querySelector('.menu-item.active .menu-badge');
                    if (badge) {
                        badge.textContent = employees.length;
                    }
                    
                    // Update page title to show it's filtered
                    const pageTitle = document.querySelector('.page-title');
                    if (pageTitle) {
                        pageTitle.textContent = `My Employees (${employees.length})`;
                    }
                })
                .catch(error => {
                    console.error('Error loading employees:', error);
                    const tbody = document.getElementById('employeesTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i><br>
                                <strong>Error loading employees</strong><br>
                                <small>Please refresh the page or contact support</small>
                            </td>
                        </tr>
                    `;
                });
        });

        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('mobile-open');
            document.getElementById('mobileOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        document.getElementById('mobileOverlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('mobile-open');
            document.getElementById('mobileOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        });

        // Employee detail functions
        function viewEmployee(employeeId) {
            fetch(`get_kebele_hr_employee_detail.php?id=${employeeId}`)
                .then(response => response.json())
                .then(employee => {
                    const details = document.getElementById('employeeDetails');
                    details.innerHTML = `
                        <div class="employee-detail-grid">
                            <div class="detail-section">
                                <h4>Basic Information</h4>
                                <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">${employee.id || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Employee ID:</span><span class="detail-value">${employee.employee_id}</span></div>
                                <div class="detail-row"><span class="detail-label">First Name:</span><span class="detail-value">${employee.first_name}</span></div>
                                <div class="detail-row"><span class="detail-label">Last Name:</span><span class="detail-value">${employee.last_name}</span></div>
                                <div class="detail-row"><span class="detail-label">Gender:</span><span class="detail-value">${employee.gender}</span></div>
                                <div class="detail-row"><span class="detail-label">Middle Name:</span><span class="detail-value">${employee.middle_name || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Date of Birth:</span><span class="detail-value">${employee.date_of_birth ? new Date(employee.date_of_birth).toLocaleDateString() : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Religion:</span><span class="detail-value">${employee.religion || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Citizenship:</span><span class="detail-value">${employee.citizenship || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Other Citizenship:</span><span class="detail-value">${employee.other_citizenship || 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Location Information</h4>
                                <div class="detail-row"><span class="detail-label">Region:</span><span class="detail-value">${employee.region || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Zone:</span><span class="detail-value">${employee.zone || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Woreda:</span><span class="detail-value">${employee.woreda || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Kebele:</span><span class="detail-value">${employee.kebele || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Address:</span><span class="detail-value">${employee.address || 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Education Information</h4>
                                <div class="detail-row"><span class="detail-label">Education Level:</span><span class="detail-value">${employee.education_level || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Primary School:</span><span class="detail-value">${employee.primary_school || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Secondary School:</span><span class="detail-value">${employee.secondary_school || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">College:</span><span class="detail-value">${employee.college || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">University:</span><span class="detail-value">${employee.university || 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Employment Information</h4>
                                <div class="detail-row"><span class="detail-label">Department:</span><span class="detail-value">${employee.department || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Other Department:</span><span class="detail-value">${employee.other_department || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Department Assigned:</span><span class="detail-value">${employee.department_assigned || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Position:</span><span class="detail-value">${employee.position || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Job Level:</span><span class="detail-value">${employee.job_level || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Other Job Level:</span><span class="detail-value">${employee.other_job_level || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Employment Type:</span><span class="detail-value">${employee.employment_type || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value">${employee.status || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Join Date:</span><span class="detail-value">${employee.join_date ? new Date(employee.join_date).toLocaleDateString() : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Salary:</span><span class="detail-value">${employee.salary ? 'ETB ' + parseFloat(employee.salary).toLocaleString() : 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Personal Status</h4>
                                <div class="detail-row"><span class="detail-label">Marital Status:</span><span class="detail-value">${employee.marital_status || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Other Marital Status:</span><span class="detail-value">${employee.other_marital_status || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Warranty Status:</span><span class="detail-value">${employee.warranty_status || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Person Name:</span><span class="detail-value">${employee.person_name || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Warranty Woreda:</span><span class="detail-value">${employee.warranty_woreda || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Warranty Kebele:</span><span class="detail-value">${employee.warranty_kebele || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Phone:</span><span class="detail-value">${employee.phone || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Warranty Type:</span><span class="detail-value">${employee.warranty_type || 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Banking & Financial</h4>
                                <div class="detail-row"><span class="detail-label">Bank Name:</span><span class="detail-value">${employee.bank_name || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Bank Account:</span><span class="detail-value">${employee.bank_account || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Fin ID:</span><span class="detail-value">${employee.fin_id || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Loan Status:</span><span class="detail-value">${employee.loan_status || 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Contact Information</h4>
                                <div class="detail-row"><span class="detail-label">Email:</span><span class="detail-value">${employee.email || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Phone Number:</span><span class="detail-value">${employee.phone_number || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Emergency Contact:</span><span class="detail-value">${employee.emergency_contact || 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>Legal & Documents</h4>
                                <div class="detail-row"><span class="detail-label">Criminal Status:</span><span class="detail-value">${employee.criminal_status || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Leave Request:</span><span class="detail-value">${employee.leave_request || 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Scan File:</span><span class="detail-value">${employee.scan_file ? '<a href="../uploads/employees/' + employee.scan_file + '" target="_blank">View</a>' : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Criminal File:</span><span class="detail-value">${employee.criminal_file ? '<a href="../uploads/employees/' + employee.criminal_file + '" target="_blank">View</a>' : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Fin Scan:</span><span class="detail-value">${employee.fin_scan ? '<a href="../uploads/employees/' + employee.fin_scan + '" target="_blank">View</a>' : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Loan File:</span><span class="detail-value">${employee.loan_file ? '<a href="../uploads/employees/' + employee.loan_file + '" target="_blank">View</a>' : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Leave Document:</span><span class="detail-value">${employee.leave_document ? '<a href="../uploads/employees/' + employee.leave_document + '" target="_blank">View</a>' : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Documents:</span><span class="detail-value">${employee.documents_array ? employee.documents_array.join(', ') : 'N/A'}</span></div>
                            </div>

                            <div class="detail-section">
                                <h4>System Information</h4>
                                <div class="detail-row"><span class="detail-label">Created At:</span><span class="detail-value">${employee.created_at ? new Date(employee.created_at).toLocaleDateString() : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Updated At:</span><span class="detail-value">${employee.updated_at ? new Date(employee.updated_at).toLocaleDateString() : 'N/A'}</span></div>
                                <div class="detail-row"><span class="detail-label">Created By:</span><span class="detail-value">${employee.created_by || 'N/A'}</span></div>
                            </div>
                        </div>
                    `;
                    document.getElementById('employeeModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading employee details:', error);
                    alert('Error loading employee details. Please try again.');
                });
        }

        function editEmployee(employeeId) {
            // Redirect to edit page (you can create this later)
            window.location.href = `edit_employee.php?id=${employeeId}`;
        }

        function deleteEmployee(employeeId) {
            if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
                // Show loading state
                const deleteBtn = document.querySelector(`button[onclick="deleteEmployee('${employeeId}')"]`);
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                fetch(`delete_employee.php?id=${employeeId}`, {
                    method: 'GET' // Using GET since we're passing ID in URL
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`✅ Employee deleted successfully!\nEmployee: ${data.employee_name}\nID: ${data.employee_id}`);
                        location.reload(); // Refresh the page
                    } else {
                        alert('❌ Error deleting employee: ' + data.error);
                        // Re-enable button
                        if (deleteBtn) {
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error deleting employee:', error);
                    alert('❌ Error deleting employee. Please try again.');
                    // Re-enable button
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    }
                });
            }
        }

        function closeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('employeeModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>